<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bulk Marks Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f7f7; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #008080; text-align: center; margin-bottom: 25px; }
        
        .filter-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #eef7f7; padding: 15px; border-radius: 10px; border: 1px solid #008080; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #444; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; }
        
        /* Highlighting Total Marks */
        #totalMarks { background: #fff; border: 2px solid #008080; font-weight: bold; color: #008080; }

        .btn-fetch { width: 100%; background: #008080; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-fetch:hover { background: #006666; }
        
        .student-list-area { margin-top: 25px; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #008080; color: white; }
        
        .mark-input { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-weight: bold; transition: 0.2s; }
        .mark-input:focus { border-color: #008080; outline: none; box-shadow: 0 0 5px rgba(0,128,128,0.2); }
        
        .btn-save { background: #2ecc71; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: block; margin: 20px auto 0; width: 100%; font-size: 16px; }
        .loading { text-align: center; display: none; margin: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-file-invoice"></i> Bulk Marks Upload</h2>

    <div class="filter-section">
        <div>
            <label>Department</label>
            <select id="targetDept">
                <option value="IT">IT</option>
                <option value="CSE">CSE</option>
                <option value="ECE">ECE</option>
                <option value="EEE">EEE</option>
                <option value="MECH">MECH</option>
                <option value="CIVIL">CIVIL</option>
		<option value="ATE">AUTO</option>
            </select>
        </div>
        <div>
            <label>Year</label>
            <select id="targetYear">
                <option value="1">1st Year</option>
                <option value="2">2nd Year</option>
                <option value="3">3rd Year</option>
                <option value="4">4th Year</option>
            </select>
        </div>
        <div>
            <label>Subject Name</label>
            <input type="text" id="subjectName" placeholder="e.g. Java, Python...">
        </div>
        <div>
            <label>Total Marks (Set this first!)</label>
            <input type="number" id="totalMarks" placeholder="e.g. 100, 75, 50" oninput="updateAllInputsMax()">
        </div>
        <button class="btn-fetch" style="grid-column: span 2;" onclick="fetchStudentsForMarks()">Get Student List</button>
    </div>

    <div id="loading" class="loading"><i class="fas fa-spinner fa-spin fa-2x" style="color: #008080;"></i></div>

    <div id="studentArea" class="student-list-area">
        <h4 id="displayInfo" style="margin-bottom: 10px; color: #008080;"></h4>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">* Marks exceeding the total will be auto-reset to max marks.</p>
        <table>
            <thead>
                <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Obtained Marks</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
        <button class="btn-save" onclick="saveBulkMarks()">Submit All Marks</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZOJh_a5oDaKluV3IU6Ly2o7PlTlSEbhQ",
        authDomain: "college-connect-2cd42.firebaseapp.com",
        databaseURL: "https://college-connect-2cd42-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "college-connect-2cd42",
        storageBucket: "college-connect-2cd42.firebasestorage.app",
        messagingSenderId: "16394931571",
        appId: "1:16394931571:web:38b8abc12ec26d7dc50906"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Dynamic Validation Functions
    window.updateAllInputsMax = () => {
        const total = document.getElementById('totalMarks').value;
        const inputs = document.querySelectorAll('.mark-input');
        inputs.forEach(input => {
            input.max = total;
            if(total) input.placeholder = "Max: " + total;
        });
    }

    window.validateMarkInput = (input) => {
        const total = parseFloat(document.getElementById('totalMarks').value);
        
        // 1. Check if Total Mark is entered
        if (isNaN(total) || total <= 0) {
            alert("Munnadi 'Total Marks' field-la mark enter pannunga staff!");
            input.value = "";
            document.getElementById('totalMarks').focus();
            return;
        }

        // 2. Prevent exceeding total
        if (parseFloat(input.value) > total) {
            alert(`Mark ${total}-ku mela irukka koodadhu!`);
            input.value = total; // Auto-reset to max
        }
    }

    window.fetchStudentsForMarks = async function() {
        const dept = document.getElementById('targetDept').value;
        const year = document.getElementById('targetYear').value;
        const subject = document.getElementById('subjectName').value.trim();
        const total = document.getElementById('totalMarks').value;

        if(!subject || !total) { 
            alert("Subject Name matrum Total Marks kandippa venum!"); 
            return; 
        }

        const loading = document.getElementById('loading');
        const studentArea = document.getElementById('studentArea');
        const tableBody = document.getElementById('studentTableBody');

        loading.style.display = 'block';
        studentArea.style.display = 'none';
        tableBody.innerHTML = "";
        document.getElementById('displayInfo').innerText = `Subject: ${subject} | Dept: ${dept} | Max Marks: ${total}`;

        try {
            const snapshot = await get(ref(db, 'users'));
            if (snapshot.exists()) {
                let found = false;
                snapshot.forEach((child) => {
                    const user = child.val();
                    const sID = child.key;

                    if (user.role === 'student' && user.dept === dept && user.year.toString() === year) {
                        found = true;
                        tableBody.innerHTML += `
                            <tr data-id="${sID}">
                                <td>${sID}</td>
                                <td>${user.name}</td>
                                <td>
                                    <input type="number" class="mark-input" 
                                           oninput="validateMarkInput(this)" 
                                           placeholder="Max: ${total}" 
                                           max="${total}">
                                </td>
                            </tr>`;
                    }
                });

                if (found) { studentArea.style.display = 'block'; }
                else { alert("Indha batch-la students yaarum illai!"); }
            }
        } catch (e) { alert("Error fetching students!"); }
        loading.style.display = 'none';
    }

    window.saveBulkMarks = async function() {
        const subject = document.getElementById('subjectName').value.trim();
        const total = document.getElementById('totalMarks').value;
        const rows = document.querySelectorAll('#studentTableBody tr');
        const updates = {};

        if(rows.length === 0) return;

        let allValid = true;
        rows.forEach(row => {
            const sID = row.getAttribute('data-id');
            const markInput = row.querySelector('.mark-input');
            const score = markInput.value;

            if(score === "") {
                allValid = false;
                markInput.style.border = "2px solid red";
            } else {
                markInput.style.border = "1px solid #ccc";
                const safeSubjectName = subject.replace(/\s+/g, '_'); 
                
                updates[`marks/${sID}/${safeSubjectName}`] = {
                    subject: subject,
                    score: score,
                    total: total,
                    timestamp: new Date().toISOString()
                };
            }
        });

        if(!allValid) {
            alert("Ellarukum mark enter pannunga!");
            return;
        }

        try {
            await update(ref(db), updates);
            alert("Success: Ellarukum Marks Upload Aayiduchu!");
            location.reload();
        } catch (e) { 
            alert("Error saving marks!"); 
        }
    }
</script>
</body>
</html>