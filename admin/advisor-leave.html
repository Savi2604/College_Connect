<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Requests & Insights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/modern-ui.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }

        .back-link {
            text-decoration: none;
            color: var(--text-light);
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .insight-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: var(--card-bg-light);
            backdrop-filter: blur(16px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-top: 4px solid var(--primary);
            border: 1px solid var(--border-light);
            border-top-width: 4px;
        }

        .insight-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
            align-items: center;
            color: var(--text-light);
        }

        .alert-email-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
        }

        .request-card {
            background: var(--card-bg-light);
            backdrop-filter: blur(16px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-light);
            border-left-width: 5px;
            color: var(--text-light);
        }

        .request-card b {
            color: var(--primary);
        }

        .approve-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .reject-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .insight-row {
                grid-template-columns: 1fr;
            }

            .request-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="dynamic-bg"></div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="index.html" class="back-link" style="margin-bottom: 0;"><i class="fas fa-arrow-left"></i></a>
    </div>

    <div class="insight-row">
        <div class="insight-card">
            <h3><i class="fas fa-history"></i> Frequent Leave Takers</h3>
            <div id="frequentList">Loading...</div>
        </div>
        <div class="insight-card">
            <h3><i class="fas fa-exclamation-triangle"></i> Overall Attendance Warnings (< 75%)</h3>
                    <div id="attendanceAlerts">Checking...</div>
        </div>
    </div>

    <h2
        style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
        Pending
        Requests</h2>
    <div id="leaveList">Loading requests...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZOJh_a5oDaKluV3IU6Ly2o7PlTlSEbhQ",
            authDomain: "college-connect-2cd42.firebaseapp.com",
            databaseURL: "https://college-connect-2cd42-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "college-connect-2cd42",
            storageBucket: "college-connect-2cd42.firebasestorage.app",
            messagingSenderId: "16394931571",
            appId: "1:16394931571:web:38b8abc12ec26d7dc50906"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const advDept = sessionStorage.getItem("dept") || "IT";
        const advYear = sessionStorage.getItem("year") || "3";

        async function loadData() {
            onValue(ref(db, 'leaverequests/'), (snapshot) => {
                let counts = {};
                let listHTML = "";
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const d = child.val();
                        if (d.dept === advDept) {
                            counts[d.name] = (counts[d.name] || 0) + 1;
                            if (d.status === "Pending" && d.year === advYear) {
                                listHTML += `<div class="request-card">
                                    <div><p><b>Student:</b> ${d.name} (${d.studentID})</p><p><b>Reason:</b> ${d.reason}</p></div>
                                    <div class="btn-group">
                                        <button class="approve-btn" onclick="updateStatus('${child.key}', 'Approved')">Approve</button>
                                        <button class="reject-btn" onclick="updateStatus('${child.key}', 'Rejected')">Reject</button>
                                    </div>
                                </div>`;
                            }
                        }
                    });
                }
                document.getElementById('leaveList').innerHTML = listHTML || "No pending requests.";
                const sorted = Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, 3);
                document.getElementById('frequentList').innerHTML = sorted.map(([n, c]) => `<div class="insight-item"><span>${n}</span><span>${c} Times</span></div>`).join('') || "No records.";
            });

            // 2. Logic updated to 75% [cite: 2026-01-15]
            const attSnap = await get(ref(db, 'attendance/'));
            if (attSnap.exists()) {
                let alertHTML = "";
                const allAttendance = attSnap.val();

                for (const studentID in allAttendance) {
                    let totalAttended = 0;
                    let totalPossible = 0;
                    let studentName = "";

                    const subjects = allAttendance[studentID];
                    for (const subKey in subjects) {
                        const subData = subjects[subKey];
                        if (subData.attended !== undefined && subData.total !== undefined) {
                            totalAttended += parseInt(subData.attended);
                            totalPossible += parseInt(subData.total);
                            studentName = subData.name;
                        }
                    }

                    if (totalPossible > 0) {
                        const overallPercent = (totalAttended / totalPossible) * 100;
                        // Threshold changed to 75 [cite: 2026-01-15]
                        if (overallPercent < 75) {
                            alertHTML += `<div class="insight-item">
                                <span>${studentName} (${overallPercent.toFixed(1)}%)</span>
                                <button class="alert-email-btn" onclick="sendAlert('${studentID}', '${studentName}', '${overallPercent.toFixed(1)}')">Alert</button>
                            </div>`;
                        }
                    }
                }
                // Fallback text updated to 75% [cite: 2026-01-15]
                document.getElementById('attendanceAlerts').innerHTML = alertHTML || "All students above 75%.";
            }
        }

        window.sendAlert = async (id, name, percent) => {
            const userSnap = await get(ref(db, `users/${id}`));
            const studentEmail = userSnap.val()?.email;
            if (studentEmail) {
                window.location.href = `mailto:${studentEmail}?subject=Attendance Warning&body=Dear ${name}, your overall attendance is ${percent}%. Please attend classes regularly.`;
            } else {
                alert("Student email not found!");
            }
        };

        window.updateStatus = (id, s) => {
            update(ref(db, `leaverequests/${id}`), { status: s }).then(() => alert("Request Status Updated!"));
        };

        loadData();
    </script>
    <script src="../js/ui.js"></script>
</body>

</html>