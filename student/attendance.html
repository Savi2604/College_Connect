<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Attendance - College Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f8fafc; padding-bottom: 30px; }
        .header { 
            background: linear-gradient(135deg, #008080 0%, #00ced1 100%); 
            color: white; padding: 20px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .header a { color: white; text-decoration: none; }
        .container { padding: 20px; max-width: 800px; margin: auto; }
        
        .student-info { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .student-info h4 { color: #008080; }

        .attendance-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        th { background: #f1f5f9; color: #475569; font-weight: bold; text-transform: uppercase; font-size: 12px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .present { background: #dcfce7; color: #166534; }
        .absent { background: #fee2e2; color: #991b1b; }
        
        .no-data { text-align: center; padding: 40px; color: #94a3b8; }
        .loading { text-align: center; padding: 50px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html"><i class="fas fa-arrow-left fa-lg"></i></a>
        <h2>My Attendance</h2>
    </div>

    <div class="container">
        <div class="student-info">
            <div>
                <h4 id="sName">Loading Profile...</h4>
                <p id="sID" style="font-size: 12px; color: #64748b;"></p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 12px; font-weight: bold; color: #475569;">Dept: <span id="sDept" style="color: #008080;">...</span></p>
            </div>
        </div>

        <div class="attendance-card">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #008080;"></i>
                <p style="margin-top:10px;">Fetching records...</p>
            </div>
            <table id="attTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="attendanceList"></tbody>
            </table>
            <div id="noData" class="no-data" style="display: none;">
                <i class="fas fa-calendar-times fa-3x" style="margin-bottom: 10px;"></i>
                <p>No attendance records have been uploaded for you yet.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZOJh_a5oDaKluV3IU6Ly2o7PlTlSEbhQ",
            authDomain: "college-connect-2cd42.firebaseapp.com",
            databaseURL: "https://college-connect-2cd42-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "college-connect-2cd42",
            storageBucket: "college-connect-2cd42.firebasestorage.app",
            messagingSenderId: "16394931571",
            appId: "1:16394931571:web:38b8abc12ec26d7dc50906"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const studentID = sessionStorage.getItem("studentID");

        // Function to Fetch Student Info directly from Firebase
        async function fetchStudentProfile() {
            if (!studentID) {
                alert("Session expired. Please log in again.");
                window.location.href = "login.html";
                return;
            }
            
            try {
                const userRef = ref(db, `users/${studentID}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('sName').innerText = userData.name || "Unknown Student";
                    document.getElementById('sID').innerText = "Roll No: " + studentID;
                    // This fixes the N/A issue by fetching directly from DB
                    document.getElementById('sDept').innerText = userData.dept || "Not Assigned";
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
            }
        }

        // Function to Load Attendance Data
        async function loadMyAttendance() {
            const tableBody = document.getElementById('attendanceList');
            const table = document.getElementById('attTable');
            const noData = document.getElementById('noData');
            const loading = document.getElementById('loading');

            try {
                const attRef = ref(db, `attendance/${studentID}`);
                const snapshot = await get(attRef);

                loading.style.display = 'none';

                if (snapshot.exists()) {
                    table.style.display = 'table';
                    const data = snapshot.val();
                    let rows = [];

                    for (let subject in data) {
                        for (let date in data[subject]) {
                            const record = data[subject][date];
                            rows.push({
                                date: date,
                                subject: subject,
                                status: record.status
                            });
                        }
                    }

                    // Sort by date (latest records first)
                    rows.sort((a, b) => new Date(b.date) - new Date(a.date));

                    tableBody.innerHTML = ""; 
                    rows.forEach(row => {
                        const statusClass = row.status.toLowerCase() === 'present' ? 'present' : 'absent';
                        tableBody.innerHTML += `
                            <tr>
                                <td style="font-weight: bold; color: #1e293b;">${row.date}</td>
                                <td style="color: #475569; text-transform: capitalize;">${row.subject}</td>
                                <td><span class="status-badge ${statusClass}">${row.status}</span></td>
                            </tr>
                        `;
                    });

                } else {
                    noData.style.display = 'block';
                }
            } catch (e) {
                console.error("Attendance Load Error:", e);
                loading.innerHTML = "Error loading attendance records.";
            }
        }

        // Execute functions
        fetchStudentProfile();
        loadMyAttendance();
    </script>
</body>
</html>